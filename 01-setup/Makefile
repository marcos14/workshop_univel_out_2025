# ============================================
# MAKEFILE - WORKSHOP LANGCHAIN + MCP + QDRANT
# ============================================
# Comandos para automaÃ§Ã£o do ambiente containerizado

.PHONY: help bootstrap up down check lint test clean build logs shell

# Target padrÃ£o - mostra ajuda
help:
	@echo "==================================================="
	@echo "  WORKSHOP LANGCHAIN + MCP + QDRANT - COMANDOS"
	@echo "==================================================="
	@echo ""
	@echo "ConfiguraÃ§Ã£o inicial:"
	@echo "  bootstrap    - Verifica Docker e configura ambiente"
	@echo "  build        - ConstrÃ³i imagens Docker"
	@echo ""
	@echo "Ambiente (todos os serviÃ§os):"
	@echo "  up           - Inicia todo o ambiente (app + qdrant + redis)"
	@echo "  down         - Para todos os serviÃ§os"
	@echo "  logs         - Mostra logs de todos os serviÃ§os"
	@echo "  status       - Mostra status dos containers"
	@echo ""
	@echo "Desenvolvimento:"
	@echo "  shell        - Abre shell no container Python"
	@echo "  check        - Executa verificaÃ§Ãµes de sanidade"
	@echo "  lint         - Verifica formataÃ§Ã£o do cÃ³digo"
	@echo "  test         - Executa testes"
	@echo ""
	@echo "UtilitÃ¡rios:"
	@echo "  clean        - Remove containers e volumes"
	@echo "  rebuild      - ReconstrÃ³i tudo do zero"
	@echo ""

# ==========================================
# CONFIGURAÃ‡ÃƒO INICIAL
# ==========================================

bootstrap:
	@echo "ğŸš€ Verificando ambiente Docker..."
	@bash scripts/bootstrap.sh
	@echo "âœ… Bootstrap concluÃ­do!"
	@echo ""
	@echo "PrÃ³ximos passos:"
	@echo "1. Configure suas chaves no arquivo .env"
	@echo "2. Execute: make up (para iniciar ambiente)"
	@echo "3. Execute: make check (para verificar tudo)"

build:
	@echo "ï¿½ Construindo imagens Docker..."
	@docker compose build --no-cache
	@echo "âœ… Imagens construÃ­das!"

rebuild: clean build up
	@echo "ğŸ”„ Ambiente reconstruÃ­do completamente!"

# ==========================================
# GERENCIAMENTO DO AMBIENTE
# ==========================================

up:
	@echo "ğŸ³ Iniciando ambiente completo..."
	@docker compose up -d
	@echo "â³ Aguardando serviÃ§os ficarem prontos..."
	@sleep 15
	@echo "ğŸŒ Ambiente disponÃ­vel:"
	@echo "   - Qdrant Dashboard: http://localhost:6333/dashboard"
	@echo "   - Qdrant API: http://localhost:6333"
	@echo "   - Redis: localhost:6379"
	@echo "   - Shell Python: make shell"
	@echo "âœ… Ambiente iniciado!"

down:
	@echo "ğŸ›‘ Parando ambiente..."
	@docker compose down
	@echo "âœ… Ambiente parado!"

logs:
	@echo "ï¿½ Logs do ambiente (Ctrl+C para sair):"
	@docker compose logs -f

status:
	@echo "ï¿½ Status dos serviÃ§os:"
	@docker compose ps

# ==========================================
# DESENVOLVIMENTO
# ==========================================

shell:
	@echo "ğŸš Abrindo shell no container Python..."
	@docker compose exec workshop-app bash

check:
	@echo "ğŸ” Executando verificaÃ§Ãµes de sanidade..."
	@docker compose exec workshop-app python -m scripts.check_env
	@echo ""

lint:
	@echo "ğŸ§¹ Verificando formataÃ§Ã£o do cÃ³digo..."
	@docker compose exec workshop-app ruff check .
	@echo "âœ… CÃ³digo verificado!"

test:
	@echo "ğŸ§ª Executando testes..."
	@docker compose exec workshop-app pytest -q
	@echo "âœ… Testes concluÃ­dos!"

# ==========================================
# UTILITÃRIOS
# ==========================================

clean:
	@echo "ğŸ§¹ Removendo containers e volumes..."
	@docker compose down -v --remove-orphans
	@docker system prune -f
	@echo "âœ… Limpeza concluÃ­da!"

# ==========================================
# COMANDOS ESPECÃFICOS
# ==========================================

# Executa comando Python no container
python-exec:
	@docker compose exec workshop-app python $(CMD)

# Instala pacote Python no container
install-package:
	@docker compose exec workshop-app pip install $(PACKAGE)

# Backup dos dados
backup:
	@echo "ğŸ’¾ Criando backup dos dados..."
	@mkdir -p backups
	@docker compose exec qdrant tar czf - /qdrant/storage > backups/qdrant-$(shell date +%Y%m%d-%H%M%S).tar.gz
	@echo "âœ… Backup salvo em backups/"

# InformaÃ§Ãµes do ambiente
info:
	@echo "â„¹ï¸  InformaÃ§Ãµes do ambiente:"
	@echo "Docker: $(shell docker --version 2>&1 || echo 'NÃ£o encontrado')"
	@echo "Docker Compose: $(shell docker compose version 2>&1 || echo 'NÃ£o encontrado')"
	@echo ""
	@echo "Containers ativos:"
	@docker compose ps --format "table {{.Name}}\t{{.Status}}\t{{.Ports}}" 2>/dev/null || echo "Nenhum container ativo"

# Reset completo do ambiente
reset: clean
	@echo "ğŸ”„ Resetando ambiente completo..."
	@docker volume prune -f
	@rm -f .env
	@echo "âœ… Reset concluÃ­do! Execute 'make bootstrap' para reconfigurar."