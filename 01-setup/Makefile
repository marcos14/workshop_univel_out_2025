# ============================================
# MAKEFILE - WORKSHOP LANGCHAIN + MCP + QDRANT
# ============================================
# Comandos para automaÃ§Ã£o do ambiente de desenvolvimento

.PHONY: help bootstrap up down check lint test clean install status logs

# Target padrÃ£o - mostra ajuda
help:
	@echo "==================================================="
	@echo "  WORKSHOP LANGCHAIN + MCP + QDRANT - COMANDOS"
	@echo "==================================================="
	@echo ""
	@echo "ConfiguraÃ§Ã£o inicial:"
	@echo "  bootstrap    - Instala dependÃªncias e configura ambiente"
	@echo "  install      - Instala apenas as dependÃªncias Python"
	@echo ""
	@echo "Docker (serviÃ§os auxiliares):"
	@echo "  up           - Inicia Qdrant e Redis"
	@echo "  down         - Para os serviÃ§os"
	@echo "  status       - Mostra status dos containers"
	@echo "  logs         - Mostra logs dos serviÃ§os"
	@echo ""
	@echo "VerificaÃ§Ãµes e testes:"
	@echo "  check        - Executa verificaÃ§Ãµes de sanidade"
	@echo "  lint         - Verifica formataÃ§Ã£o do cÃ³digo"
	@echo "  test         - Executa testes (quando disponÃ­veis)"
	@echo ""
	@echo "UtilitÃ¡rios:"
	@echo "  clean        - Remove arquivos temporÃ¡rios"
	@echo ""

# ==========================================
# CONFIGURAÃ‡ÃƒO INICIAL
# ==========================================

bootstrap:
	@echo "ðŸš€ Iniciando configuraÃ§Ã£o do ambiente..."
	@echo "ðŸ“‹ Executando script de bootstrap..."
	@bash scripts/bootstrap.sh
	@echo "âœ… Bootstrap concluÃ­do!"
	@echo ""
	@echo "PrÃ³ximos passos:"
	@echo "1. Configure suas chaves no arquivo .env"
	@echo "2. Execute: make up (para iniciar serviÃ§os)"
	@echo "3. Execute: make check (para verificar tudo)"

install:
	@echo "ðŸ“¦ Instalando dependÃªncias Python..."
	@poetry install
	@echo "âœ… DependÃªncias instaladas!"

# ==========================================
# DOCKER SERVICES
# ==========================================

up:
	@echo "ðŸ³ Iniciando serviÃ§os (Qdrant + Redis)..."
	@docker compose up -d
	@echo "â³ Aguardando serviÃ§os ficarem prontos..."
	@sleep 10
	@echo "ðŸŒ ServiÃ§os disponÃ­veis:"
	@echo "   - Qdrant Dashboard: http://localhost:6333/dashboard"
	@echo "   - Qdrant API: http://localhost:6333"
	@echo "   - Redis: localhost:6379"
	@echo "âœ… ServiÃ§os iniciados!"

down:
	@echo "ðŸ›‘ Parando serviÃ§os..."
	@docker compose down
	@echo "âœ… ServiÃ§os parados!"

status:
	@echo "ðŸ“Š Status dos serviÃ§os:"
	@docker compose ps

logs:
	@echo "ðŸ“‹ Logs dos serviÃ§os (Ctrl+C para sair):"
	@docker compose logs -f

# ==========================================
# VERIFICAÃ‡Ã•ES E TESTES
# ==========================================

check:
	@echo "ðŸ” Executando verificaÃ§Ãµes de sanidade..."
	@poetry run python -m scripts.check_env
	@echo ""

lint:
	@echo "ðŸ§¹ Verificando formataÃ§Ã£o do cÃ³digo..."
	@poetry run ruff check .
	@echo "âœ… CÃ³digo formatado corretamente!"

test:
	@echo "ðŸ§ª Executando testes..."
	@poetry run pytest -q
	@echo "âœ… Testes concluÃ­dos!"

# ==========================================
# UTILITÃRIOS
# ==========================================

clean:
	@echo "ðŸ§¹ Limpando arquivos temporÃ¡rios..."
	@find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	@find . -type f -name "*.pyc" -delete 2>/dev/null || true
	@find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	@find . -type d -name ".ruff_cache" -exec rm -rf {} + 2>/dev/null || true
	@echo "âœ… Limpeza concluÃ­da!"

# ==========================================
# COMANDOS AVANÃ‡ADOS
# ==========================================

# Reset completo do ambiente
reset: down clean
	@echo "ðŸ”„ Resetando ambiente completo..."
	@docker compose down -v
	@rm -f .env
	@echo "âœ… Reset concluÃ­do! Execute 'make bootstrap' para reconfigurar."

# Backup dos dados
backup:
	@echo "ðŸ’¾ Criando backup dos dados..."
	@mkdir -p backups
	@docker compose exec qdrant tar czf - /qdrant/storage > backups/qdrant-$(shell date +%Y%m%d-%H%M%S).tar.gz
	@echo "âœ… Backup salvo em backups/"

# InformaÃ§Ãµes do ambiente
info:
	@echo "â„¹ï¸  InformaÃ§Ãµes do ambiente:"
	@echo "Python: $(shell python --version 2>&1 || echo 'NÃ£o encontrado')"
	@echo "Poetry: $(shell poetry --version 2>&1 || echo 'NÃ£o encontrado')"
	@echo "Docker: $(shell docker --version 2>&1 || echo 'NÃ£o encontrado')"
	@echo "Docker Compose: $(shell docker compose version 2>&1 || echo 'NÃ£o encontrado')"